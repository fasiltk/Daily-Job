{% extends 'customer/base.html' %}

{% load static %}

{% block title %}Customer{% endblock %}

{% block head %}
<style>
    .buttonss{
  padding: 10px 20px;
    background-color: rgb(26, 34, 38);
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}

.icons{
    margin: -60px 0px 0px 795px;
}
</style>
{% endblock %}

{% block content %}
<div class="icons">
    {% if role == "labour" %}
    <a href="{% url 'labour:home' %}"><button class="buttonss">Home</button></a>
    <a href="{% url 'labour:addjob' %}"><button class="buttonss">Add Job</button></a>
    <a href="{% url 'location:map_view' %}"><button class="buttonss">Map</button></a>
    <a href="{% url 'authsystem:change_password' %}"><button class="buttonss">Change Password</button></a>
    <a href="{% url 'authsystem:logout_view' %}"><button class="buttonss">Log Out</button></a>


    {% else %}
    <a href="{% url 'customer:home' %}"><button class="buttonss">Home</button></a>
    <a href="{% url 'customer:cart' %}"><button class="buttonss">Cart</button></a>
    <a href="{% url 'location:map_view' %}"><button class="buttonss">Map</button></a>
    <a href="{% url 'authsystem:change_password' %}"><button class="buttonss">Change Password</button></a>
    <a href="{% url 'authsystem:logout_view' %}"><button class="buttonss">Log Out</button></a>

    {% endif %}
</div>

<div style="display:flex; height:90vh;">
    <!-- Left side: partner selection -->
    <div style="width:30%; border-right:1px solid #ccc; padding:10px;">
        <h4>Select Partner</h4>
        <form method="get">
    <select name="partner_id" class="form-select" onchange="this.form.submit()">
        <option value="">-- Select --</option>
        {% for p in partners %}
            <option value="{{ p.id }}">
            <!-- <option value="{{ p.id }}" {% if selected_partner and selected_partner.id|stringformat:"s" == p.id|stringformat:"s" %}selected{% endif %}> -->

                {{ p.name }}
            </option>
        {% endfor %}
    </select>
</form>

    </div>

    <!-- Right side: chat -->
    <div style="flex:1; padding:10px; display:flex; flex-direction:column;">
        {% if selected_partner %}
            <h5>Chat with {{ selected_partner.name }}</h5>

            <!-- Messages area -->
            <div style="flex-grow:1; border:1px solid #ccc; margin-top:10px; padding:10px; overflow-y:auto;">
                {% for msg in messages %}
                    <div style="margin-bottom:8px;">
                    <!-- <div style="margin-bottom:8px; {% if labour and msg.sender_type == 'labour' or customer and msg.sender_type == 'customer' %}text-align:right;{% endif %}"> -->

                        <strong>{{ msg.sender_type|capfirst }}:</strong> {{ msg.message }}
                        <br><small style="color:gray;">{{ msg.timestamp|date:"H:i d/m/Y" }}</small>
                    </div>
                {% empty %}
                    <p style="color:gray;">No messages yet.</p>
                {% endfor %}
            </div>

            <!-- Send message -->
            <form method="post" style="display:flex; margin-top:10px;">
                {% csrf_token %}
                <input type="hidden" name="partner_id_hidden" value="{{ selected_partner.id }}">
                <input type="text" name="message" class="form-control" placeholder="Type a message..." required>
                <button type="submit" class="btn btn-primary">Send</button>
            </form>

            <!-- Delete chat -->
            <form 
                action="{% if labour %}
                            {% url 'chat:delete_chat' labour.id selected_partner.id %}
                        {% else %}
                            {% url 'chat:delete_chat' selected_partner.id customer.id %}
                        {% endif %}" 
                method="post" style="margin-top:10px;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Delete Chat</button>
            </form>
        {% else %}
            <p>Select a partner to start chat</p>
        {% endif %}
    </div>
</div>
{% endblock %}
